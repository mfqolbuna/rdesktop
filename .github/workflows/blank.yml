name: ğŸš€ SEVER AI STV PREMIUM VÄ¨NH Cá»¬U

on:
  workflow_dispatch:
    inputs:
      note:
        description: 'ğŸ“ Ghi chÃº (tÃ¹y chá»n)'
        required: false
        default: 'PhiÃªn lÃ m viá»‡c vÄ©nh cá»­u'
        type: string

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 0  # KhÃ´ng giá»›i háº¡n thá»i gian
    
    steps:
      # BANNER CHÃ€O Má»ªNG
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG VÄ¨NH Cá»¬U
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ğŸ•Šï¸  AI STV PREMIUM RDP SERVER VÄ¨NH Cá»¬U" -ForegroundColor Cyan
          Write-Host "âš¡ Powered by AI STV" -ForegroundColor Green
          Write-Host "â³ Thá»i gian: VÄ¨NH VIá»„N (cho Ä‘áº¿n khi dá»«ng thá»§ cÃ´ng)" -ForegroundColor Yellow
          Write-Host "ğŸ“ Ghi chÃº: ${{ github.event.inputs.note }}" -ForegroundColor Magenta
          Write-Host ""
          
          # Hiá»‡u á»©ng loading
          $frames = @('â™¾ï¸', 'âˆ', 'â™¾ï¸', 'âˆ', 'â™¾ï¸', 'âˆ')
          for($i=0; $i -lt 15; $i++) {
              Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng vÄ©nh cá»­u... $($frames[$i % 6])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Milliseconds 200
          }
          Write-Host "`râœ… Há»‡ thá»‘ng vÄ©nh cá»­u Ä‘Ã£ sáºµn sÃ ng!                    " -ForegroundColor Green

      # Cáº¤U HÃŒNH NÃ‚NG CAO
      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG VÄ¨NH Cá»¬U
        run: |
          Write-Host ""
          Write-Host "â™¾ï¸  ÄANG Cáº¤U HÃŒNH Há»† THá»NG VÄ¨NH Cá»¬U" -ForegroundColor Cyan
          
          $steps = @(
              @{Name="Báº­t Remote Desktop"; Script={ 
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              }},
              @{Name="Táº¯t xÃ¡c thá»±c máº¡ng"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Cáº¥u hÃ¬nh báº£o máº­t RDP"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
              }},
              @{Name="Má»Ÿ port 3389 firewall"; Script={
                  netsh advfirewall firewall add rule name="RDP-VÄ©nh-Cá»­u" dir=in action=allow protocol=TCP localport=3389 profile=any
                  netsh advfirewall firewall add rule name="RDP-VÄ©nh-Cá»­u-Out" dir=out action=allow protocol=TCP localport=3389 profile=any
              }},
              @{Name="Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥ vÄ©nh cá»­u"; Script={
                  Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue
                  Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue
                  Start-Service -Name TermService -ErrorAction SilentlyContinue
                  Start-Service -Name UmRdpService -ErrorAction SilentlyContinue
                  # Cáº¥u hÃ¬nh Ä‘á»ƒ dá»‹ch vá»¥ tá»± Ä‘á»™ng khá»Ÿi Ä‘á»™ng láº¡i náº¿u bá»‹ dá»«ng
                  sc.exe failure TermService reset=0 actions=restart/5000
                  sc.exe failure UmRdpService reset=0 actions=restart/5000
              }}
          )
          
          foreach($step in $steps) {
              Write-Host "â”‚ â™¾ï¸  $($step.Name)..." -NoNewline -ForegroundColor White
              try {
                  & $step.Script
                  Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`râ”‚ âš ï¸  $($step.Name) - ÄÃ£ bá» qua lá»—i nhá»" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 500
          }
          
          Write-Host "ğŸ¯ Cáº¥u hÃ¬nh vÄ©nh cá»­u hoÃ n táº¥t!" -ForegroundColor Green

      # Táº O USER PREMIUM VÄ¨NH Cá»¬U
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N VÄ¨NH Cá»¬U
        run: |
          Write-Host ""
          Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N VÄ¨NH Cá»¬U" -ForegroundColor Cyan
          
          # HÃ m táº¡o password máº¡nh
          function New-PremiumPassword {
              param()
              $upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ'
              $lower = 'abcdefghijkmnpqrstuvwxyz'
              $numbers = '23456789'
              $all = $upper + $lower + $numbers

              # Táº¡o password 12 kÃ½ tá»±
              $pw = ''
              $pw += $upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]
              $pw += $lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]
              $pw += $numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]

              for ($i = 1; $i -le 9; $i++) {
                  $pw += $all[(Get-Random -Minimum 0 -Maximum $all.Length)]
              }

              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }

          # Náº¿u ngÆ°á»i dÃ¹ng Ä‘áº·t máº­t kháº©u tÃ¹y chá»‰nh thÃ¬ Æ°u tiÃªn dÃ¹ng
          if ($env:CUSTOM_RDP_PASS) {
              $matKhau = $env:CUSTOM_RDP_PASS
              Write-Host "â”‚ â„¹ï¸  DÃ¹ng máº­t kháº©u tÃ¹y chá»‰nh tá»« env" -ForegroundColor Blue
          } else {
              $matKhau = New-PremiumPassword
          }

          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          # XÃ³a user cÅ© náº¿u tá»“n táº¡i
          try {
              Remove-LocalUser -Name "AISTV-FOREVER" -ErrorAction SilentlyContinue
              Write-Host "â”‚ âœ… ÄÃ£ xÃ³a user cÅ©" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ â„¹ï¸  KhÃ´ng cÃ³ user cÅ© Ä‘á»ƒ xÃ³a" -ForegroundColor Blue
          }
          
          # Táº¡o user má»›i vá»›i Ä‘áº§y Ä‘á»§ quyá»n vÄ©nh cá»­u
          try {
              New-LocalUser -Name "AISTV-FOREVER" -Password $securePass -AccountNeverExpires -Description "AI STV VÄ©nh Cá»­u Account"
              Write-Host "â”‚ âœ… ÄÃ£ táº¡o user vÄ©nh cá»­u" -ForegroundColor Green
              
              # Äáº·t password khÃ´ng bao giá» háº¿t háº¡n
              try {
                  Set-LocalUser -Name "AISTV-FOREVER" -PasswordNeverExpires $true -ErrorAction SilentlyContinue
              } catch {
                  # Náº¿u mÃ´i trÆ°á»ng khÃ´ng há»— trá»£ Set-LocalUser, bá» qua an toÃ n
              }

              # ThÃªm vÃ o cÃ¡c nhÃ³m cáº§n thiáº¿t
              Add-LocalGroupMember -Group "Administrators" -Member "AISTV-FOREVER" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-FOREVER" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Users" -Member "AISTV-FOREVER" -ErrorAction SilentlyContinue
              
              # KÃ­ch hoáº¡t user
              Enable-LocalUser -Name "AISTV-FOREVER"
              
              Write-Host "â”‚ âœ… ÄÃ£ cáº¥p quyá»n Administrator & RDP vÄ©nh cá»­u" -ForegroundColor Green
              
          } catch {
              Write-Host "â”‚ âŒ Lá»—i táº¡o user: $($_.Exception.Message)" -ForegroundColor Red
              exit 1
          }
          
          # LÆ°u thÃ´ng tin
          echo "RDP_USER=AISTV-FOREVER" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          
          Write-Host "âœ… TÃ i khoáº£n vÄ©nh cá»­u: AISTV-FOREVER Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

      # KIá»‚M TRA QUYá»€N ÄÄ‚NG NHáº¬P
      - name: ğŸ” KIá»‚M TRA QUYá»€N Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ” KIá»‚M TRA QUYá»€N ÄÄ‚NG NHáº¬P VÄ¨NH Cá»¬U" -ForegroundColor Cyan
          
          # Kiá»ƒm tra user tá»“n táº¡i
          $user = Get-LocalUser -Name "AISTV-FOREVER" -ErrorAction SilentlyContinue
          if ($user) {
              Write-Host "â”‚ âœ… User AISTV-FOREVER tá»“n táº¡i" -ForegroundColor Green
              Write-Host "â”‚ ğŸ“Š Tráº¡ng thÃ¡i: $($user.Enabled)" -ForegroundColor White
              Write-Host "â”‚ ğŸ“… Háº¿t háº¡n: $($user.AccountExpires)" -ForegroundColor White
          } else {
              Write-Host "â”‚ âŒ User khÃ´ng tá»“n táº¡i" -ForegroundColor Red
              exit 1
          }
          
          # Kiá»ƒm tra quyá»n Administrator
          $isAdmin = (Get-LocalGroupMember -Group "Administrators" | Where-Object {$_.Name -like "*AISTV-FOREVER"}).Count -gt 0
          if ($isAdmin) {
              Write-Host "â”‚ âœ… CÃ³ quyá»n Administrator" -ForegroundColor Green
          } else {
              Write-Host "â”‚ âŒ KhÃ´ng cÃ³ quyá»n Administrator" -ForegroundColor Red
          }
          
          # Kiá»ƒm tra quyá»n Remote Desktop
          $isRDPUser = (Get-LocalGroupMember -Group "Remote Desktop Users" | Where-Object {$_.Name -like "*AISTV-FOREVER"}).Count -gt 0
          if ($isRDPUser) {
              Write-Host "â”‚ âœ… CÃ³ quyá»n Remote Desktop" -ForegroundColor Green
          } else {
              Write-Host "â”‚ âŒ KhÃ´ng cÃ³ quyá»n Remote Desktop" -ForegroundColor Red
          }
          
          # Kiá»ƒm tra dá»‹ch vá»¥ RDP
          $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
          if ($termService.Status -eq 'Running') {
              Write-Host "â”‚ âœ… Dá»‹ch vá»¥ TermService Ä‘ang cháº¡y" -ForegroundColor Green
          } else {
              Write-Host "â”‚ âŒ Dá»‹ch vá»¥ TermService khÃ´ng cháº¡y" -ForegroundColor Red
          }
          
          Write-Host "ğŸ¯ Kiá»ƒm tra vÄ©nh cá»­u hoÃ n táº¥t!" -ForegroundColor Green

      # TAILSCALE VÄ¨NH Cá»¬U
      - name: ğŸŒ THIáº¾T Láº¬P Máº NG VÄ¨NH Cá»¬U
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host ""
          Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG VÄ¨NH Cá»¬U" -ForegroundColor Cyan
          
          # CÃ i Ä‘áº·t Tailscale
          try {
              $msiPath = "$env:TEMP\tailscale-forever.msi"
              Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
              Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $msiPath -Force -ErrorAction SilentlyContinue
              Write-Host "â”‚ âœ… CÃ i Ä‘áº·t Tailscale thÃ nh cÃ´ng" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ âŒ Lá»—i cÃ i Ä‘áº·t Tailscale" -ForegroundColor Red
          }
          
          # Chá» dá»‹ch vá»¥ khá»Ÿi Ä‘á»™ng
          Start-Sleep -Seconds 10
          
          # Káº¿t ná»‘i Tailscale vá»›i cÃ i Ä‘áº·t vÄ©nh cá»­u
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-forever-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset --exit-node-allow-lan-access=true
              Write-Host "â”‚ âœ… Káº¿t ná»‘i Tailscale vÄ©nh cá»­u thÃ nh cÃ´ng" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ âŒ Lá»—i káº¿t ná»‘i Tailscale" -ForegroundColor Red
          }
          
          # Láº¥y IP Tailscale vá»›i retry mechanism
          Write-Host "â™¾ï¸  Äang láº¥y Ä‘á»‹a chá»‰ IP Tailscale..." -NoNewline -ForegroundColor Blue
          $tailscaleIP = $null
          for($i=0; $i -lt 30; $i++) {
              try {
                  $tailscaleIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>&1
                  if ($tailscaleIP -and $tailscaleIP -match '^\d+\.\d+\.\d+\.\d+$') {
                      Write-Host "`râœ… Äá»‹a chá»‰ IP Tailscale: $tailscaleIP" -ForegroundColor Green
                      break
                  }
              } catch {
                  # Bá» qua lá»—i vÃ  thá»­ láº¡i
              }
              Write-Host "`râ™¾ï¸  Äang láº¥y Ä‘á»‹a chá»‰ IP Tailscale... $(@('.', '..', '...')[$i % 3])" -NoNewline -ForegroundColor Blue
              Start-Sleep -Seconds 3
          }
          
          # Láº¥y IP Local tá»± Ä‘á»™ng
          Write-Host ""
          Write-Host "ğŸŒ Äang láº¥y Ä‘á»‹a chá»‰ IP Local..." -NoNewline -ForegroundColor Blue
          $localIP = $null
          try {
              # Láº¥y táº¥t cáº£ IP tá»« táº¥t cáº£ adapter Ä‘ang hoáº¡t Ä‘á»™ng
              $networkAdapters = Get-NetAdapter -Physical | Where-Object { $_.Status -eq 'Up' }
              
              foreach ($adapter in $networkAdapters) {
                  $ips = Get-NetIPAddress -InterfaceAlias $adapter.Name -AddressFamily IPv4 | Where-Object { $_.IPAddress -notlike '169.254.*' -and $_.IPAddress -notlike '127.0.0.1' }
                  
                  foreach ($ip in $ips) {
                      if ($ip.IPAddress -match '^\d+\.\d+\.\d+\.\d+$') {
                          $localIP = $ip.IPAddress
                          Write-Host "`râœ… Äá»‹a chá»‰ IP Local: $localIP (tá»« $($adapter.Name))" -ForegroundColor Green
                          break
                      }
                  }
                  
                  if ($localIP) { break }
              }
          } catch {
              Write-Host "`râš ï¸  KhÃ´ng thá»ƒ láº¥y IP Local" -ForegroundColor Yellow
          }
          
          # Æ¯u tiÃªn sá»­ dá»¥ng Tailscale IP, náº¿u khÃ´ng cÃ³ thÃ¬ dÃ¹ng Local IP
          if ($tailscaleIP -and $tailscaleIP -match '^\d+\.\d+\.\d+\.\d+$') {
              echo "SERVER_IP=$tailscaleIP" >> $env:GITHUB_ENV
              echo "IP_TYPE=Tailscale" >> $env:GITHUB_ENV
          } elseif ($localIP -and $localIP -match '^\d+\.\d+\.\d+\.\d+$') {
              echo "SERVER_IP=$localIP" >> $env:GITHUB_ENV
              echo "IP_TYPE=Local" >> $env:GITHUB_ENV
          } else {
              # Fallback: Láº¥y IP tá»« ipconfig
              try {
                  $fallbackIP = (Get-NetIPConfiguration | Where-Object { $_.IPv4Address.IPAddress -notlike '169.254.*' -and $_.IPv4Address.IPAddress -notlike '127.0.0.1' } | Select-Object -First 1).IPv4Address.IPAddress
                  if ($fallbackIP) {
                      echo "SERVER_IP=$fallbackIP" >> $env:GITHUB_ENV
                      echo "IP_TYPE=Fallback" >> $env:GITHUB_ENV
                      Write-Host "âœ… Sá»­ dá»¥ng Ä‘á»‹a chá»‰ IP Fallback: $fallbackIP" -ForegroundColor Green
                  } else {
                      throw "KhÃ´ng thá»ƒ láº¥y IP"
                  }
              } catch {
                  echo "SERVER_IP=dynamic" >> $env:GITHUB_ENV
                  echo "IP_TYPE=Dynamic" >> $env:GITHUB_ENV
                  Write-Host "âš ï¸  KhÃ´ng thá»ƒ láº¥y IP tÄ©nh, sá»­ dá»¥ng IP Ä‘á»™ng" -ForegroundColor Yellow
              }
          }
          
          # Cáº¥u hÃ¬nh Tailscale Ä‘á»ƒ cháº¡y vÄ©nh cá»­u
          Write-Host "â”‚ âš™ï¸  Cáº¥u hÃ¬nh Tailscale vÄ©nh cá»­u..." -ForegroundColor White
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" set --exit-node-allow-lan-access=true
              & "$env:ProgramFiles\Tailscale\tailscale.exe" set --hostname="ai-stv-forever-$env:GITHUB_RUN_ID"
              Write-Host "â”‚ âœ… Cáº¥u hÃ¬nh Tailscale hoÃ n táº¥t" -ForegroundColor Green
          } catch {
              Write-Host "â”‚ âš ï¸  Cáº¥u hÃ¬nh Tailscale tháº¥t báº¡i (bá» qua)" -ForegroundColor Yellow
          }

      # HIá»‚N THá»Š GIAO DIá»†N Äáº¸P
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I VÄ¨NH Cá»¬U
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          if (-not $matKhau) {
              $matKhau = "KhÃ´ng thá»ƒ Ä‘á»c máº­t kháº©u"
          }
          
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          
          # XÃ¡c Ä‘á»‹nh loáº¡i IP Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng tin phÃ¹ há»£p
          $ipType = $env:IP_TYPE
          $serverIP = $env:SERVER_IP
          
          if ($ipType -eq "Tailscale") {
              $ipInfo = "ğŸŒ Tailscale IP: $serverIP"
              $connectionNote = "âœ… Káº¿t ná»‘i qua Tailscale (á»•n Ä‘á»‹nh nháº¥t)"
          } elseif ($ipType -eq "Local") {
              $ipInfo = "ğŸ  Local IP: $serverIP"
              $connectionNote = "âš ï¸  Chá»‰ hoáº¡t Ä‘á»™ng trong máº¡ng ná»™i bá»™"
          } elseif ($ipType -eq "Fallback") {
              $ipInfo = "ğŸ”§ Fallback IP: $serverIP"
              $connectionNote = "âš ï¸  CÃ³ thá»ƒ cáº§n cáº¥u hÃ¬nh máº¡ng"
          } else {
              $ipInfo = "ğŸ”Œ IP: Äá»™ng (tá»± Ä‘á»™ng nháº­n)"
              $connectionNote = "âš ï¸  Kiá»ƒm tra IP báº±ng ipconfig trÃªn server"
          }
          
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚           ğŸ‰ Káº¾T Ná»I VÄ¨NH Cá»¬U THÃ€NH CÃ”NG!            â”‚" -ForegroundColor Cyan
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ $ipInfo" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤  TÃ i khoáº£n: AISTV-FOREVER" -ForegroundColor White
          Write-Host "â”‚ ğŸ”  Máº­t kháº©u: $matKhau" -ForegroundColor White
          Write-Host "â”‚ â°  Thá»i lÆ°á»£ng: VÄ¨NH VIá»„N (KhÃ´ng giá»›i háº¡n)" -ForegroundColor Yellow
          Write-Host "â”‚ ğŸ•  Báº¯t Ä‘áº§u: $($thoiGianBatDau.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ“  Port: 3389" -ForegroundColor White
          Write-Host "â”‚ ğŸ“  Ghi chÃº: ${{ github.event.inputs.note }}" -ForegroundColor Magenta
          Write-Host "â”‚ ğŸ’¡  $connectionNote" -ForegroundColor Cyan
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸ’¡  HÆ°á»›ng dáº«n káº¿t ná»‘i:                                    â”‚" -ForegroundColor Cyan
          Write-Host "â”‚   1. Má»Ÿ Remote Desktop Connection                         â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   2. Nháº­p Ä‘á»‹a chá»‰: $serverIP                              â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   3. Username: AISTV-FOREVER                              â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   4. Password: (xem á»Ÿ trÃªn)                               â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   5. Sá»­ dá»¥ng khÃ´ng giá»›i háº¡n thá»i gian! ğŸš€                â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   âš ï¸  LÆ°u Ã½: Server sáº½ cháº¡y Ä‘áº¿n khi báº¡n dá»«ng workflow      â”‚" -ForegroundColor Red
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan
          
          # Táº¡o file káº¿t ná»‘i RDP tá»± Ä‘á»™ng
          $rdpContent = @"
screen mode id:i:2
use multimon:i:0
desktopwidth:i:1920
desktopheight:i:1080
session bpp:i:32
winposstr:s:0,1,0,0,800,600
compression:i:1
keyboardhook:i:2
audiocapturemode:i:0
videoplaybackmode:i:1
connection type:i:7
networkautodetect:i:1
bandwidthautodetect:i:1
displayconnectionbar:i:1
enableworkspacereconnect:i:0
disable wallpaper:i:0
allow font smoothing:i:0
allow desktop composition:i:0
disable full window drag:i:1
disable menu anims:i:1
disable themes:i:0
disable cursor setting:i:0
bitmapcachepersistenable:i:1
full address:s:$serverIP
audiomode:i:0
redirectprinters:i:1
redirectcomports:i:0
redirectsmartcards:i:1
redirectclipboard:i:1
redirectposdevices:i:0
autoreconnection enabled:i:1
authentication level:i:0
prompt for credentials:i:0
negotiate security layer:i:1
remoteapplicationmode:i:0
alternate shell:s:
shell working directory:s:
gatewayhostname:s:
gatewayusagemethod:i:4
gatewaycredentialssource:i:4
gatewayprofileusagemethod:i:0
promptcredentialonce:i:0
gatewaybrokeringtype:i:0
use redirection server name:i:0
rdgiskdcproxy:i:0
kdcproxyname:s:
username:s:AISTV-FOREVER
"@
          
          $rdpContent | Out-File -FilePath "$env:TEMP\AI_STV_FOREVER.rdp" -Encoding UTF8
          Write-Host "ğŸ“ File káº¿t ná»‘i RDP Ä‘Ã£ Ä‘Æ°á»£c táº¡o: $env:TEMP\AI_STV_FOREVER.rdp" -ForegroundColor Green

      # DUY TRÃŒ PHIÃŠN VÄ¨NH Cá»¬U
      - name: â™¾ï¸ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C VÄ¨NH Cá»¬U
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt -ErrorAction SilentlyContinue
          
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $thoiGianBatDau = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          
          Write-Host ""
          Write-Host "â™¾ï¸ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C VÄ¨NH Cá»¬U..." -ForegroundColor Cyan
          Write-Host "ğŸ’ PhiÃªn: AI STV VÄ¨NH Cá»¬U" -ForegroundColor Magenta
          Write-Host "ğŸ”— Äá»‹a chá»‰ káº¿t ná»‘i: $env:SERVER_IP" -ForegroundColor Cyan
          Write-Host "ğŸ“Š Loáº¡i IP: $env:IP_TYPE" -ForegroundColor Yellow
          Write-Host "ğŸ• Báº¯t Ä‘áº§u: $($thoiGianBatDau.ToString('HH:mm:ss dd/MM/yyyy'))" -ForegroundColor Green
          Write-Host "â° Tráº¡ng thÃ¡i: ÄANG HOáº T Äá»˜NG VÄ¨NH VIá»„N" -ForegroundColor Yellow
          Write-Host "âš ï¸  LÆ°u Ã½: Server sáº½ cháº¡y Ä‘áº¿n khi báº¡n nháº¥n Cancel workflow" -ForegroundColor Red
          Write-Host ""
          
          # Táº¡o process giÃ¡m sÃ¡t há»‡ thá»‘ng vÄ©nh cá»­u
          $monitorScript = {
              $lastLogTime = Get-Date
              $lastRestartTime = Get-Date
              while ($true) {
                  $currentTime = Get-Date
                  
                  # Log tráº¡ng thÃ¡i má»—i 5 phÃºt
                  if (($currentTime - $lastLogTime).TotalMinutes -ge 5) {
                      # Kiá»ƒm tra dá»‹ch vá»¥
                      $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                      $rdpConnections = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue | Where-Object {$_.State -eq 'Established'}
                      $uptime = $currentTime - $lastRestartTime
                      
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] â™¾ï¸  Uptime: $([math]::Floor($uptime.TotalHours))h, RDP: $($termService.Status), Connections: $($rdpConnections.Count)" -ForegroundColor Blue
                      $lastLogTime = $currentTime
                  }
                  
                  # Kiá»ƒm tra vÃ  khá»Ÿi Ä‘á»™ng láº¡i dá»‹ch vá»¥ náº¿u cáº§n (má»—i 30 phÃºt)
                  if (($currentTime - $lastRestartTime).TotalMinutes -ge 30) {
                      $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                      if ($termService.Status -eq 'Running') {
                          Write-Host "[$($currentTime.ToString('HH:mm:ss'))] ğŸ”„ Khá»Ÿi Ä‘á»™ng láº¡i dá»‹ch vá»¥ Ä‘á»ƒ Ä‘áº£m báº£o á»•n Ä‘á»‹nh..." -ForegroundColor Yellow
                          Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue
                          $lastRestartTime = $currentTime
                      }
                  }
                  
                  # Kiá»ƒm tra dá»‹ch vá»¥ má»—i 30 giÃ¢y
                  $termService = Get-Service -Name TermService -ErrorAction SilentlyContinue
                  if ($termService.Status -ne 'Running') {
                      Write-Host "[$($currentTime.ToString('HH:mm:ss'))] ğŸ”„ PhÃ¡t hiá»‡n dá»‹ch vá»¥ dá»«ng, khá»Ÿi Ä‘á»™ng láº¡i..." -ForegroundColor Red
                      Start-Service -Name TermService -ErrorAction SilentlyContinue
                  }
                  
                  Start-Sleep -Seconds 30
              }
          }
          
          # Cháº¡y monitor trong background
          Start-Job -ScriptBlock $monitorScript -Name "SystemMonitorForever"
          
          # Hiá»ƒn thá»‹ timer vÄ©nh cá»­u
          $frames = @('â™¾ï¸', 'âˆ', 'â­•', 'ğŸ”', 'ğŸ”„', 'âš¡', 'ğŸŒŸ', 'ğŸ’«', 'âœ¨', 'ğŸ¯')
          $colors = @('Cyan', 'Blue', 'Green', 'Yellow', 'Magenta', 'White')
          $startTime = Get-Date
          
          # VÃ²ng láº·p vÄ©nh cá»­u
          while ($true) {
              $thoiGianHienTai = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $thoiGianHoatDong = (Get-Date) - $startTime
              
              $ngayHoatDong = [math]::Floor($thoiGianHoatDong.TotalDays)
              $gioHoatDong = [math]::Floor($thoiGianHoatDong.TotalHours % 24)
              $phutHoatDong = [math]::Floor($thoiGianHoatDong.TotalMinutes % 60)
              $giayHoatDong = [math]::Floor($thoiGianHoatDong.TotalSeconds % 60)
              
              $frame = $frames[([int]((Get-Date) - $startTime).TotalSeconds) % $frames.Length]
              $color = $colors[([int]((Get-Date) - $startTime).TotalMinutes) % $colors.Length]
              
              Write-Host "`r$frame [$($thoiGianHienTai.ToString('HH:mm:ss'))] ÄÃ£ hoáº¡t Ä‘á»™ng: ${ngayHoatDong}d ${gioHoatDong}h ${phutHoatDong}m ${giayHoatDong}s | IP: $env:SERVER_IP" -NoNewline -ForegroundColor $color
              
              # Kiá»ƒm tra náº¿u workflow bá»‹ cancel
              if (Test-Path "$env:GITHUB_WORKSPACE\.github\workflows\CANCEL_FLAG") {
                  Write-Host ""
                  Write-Host "âš ï¸  PhÃ¡t hiá»‡n yÃªu cáº§u dá»«ng workflow..." -ForegroundColor Red
                  break
              }
              
              Start-Sleep -Seconds 5
          }

      # Dá»ŒN Dáº¸P (chá»‰ cháº¡y khi workflow bá»‹ cancel)
      - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG VÄ¨NH Cá»¬U
        if: cancelled()  # Chá»‰ cháº¡y khi workflow bá»‹ cancel
        run: |
          Write-Host ""
          Write-Host "ğŸ§¹ ÄANG Dá»ŒN Dáº¸P Há»† THá»NG VÄ¨NH Cá»¬U..." -ForegroundColor Yellow
          
          $cleanupSteps = @(
              @{Name="XÃ³a file password"; Script={
                  Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
                  Remove-Item "$env:TEMP\AI_STV_FOREVER.rdp" -ErrorAction SilentlyContinue
              }},
              @{Name="VÃ´ hiá»‡u hÃ³a user vÄ©nh cá»­u"; Script={
                  Disable-LocalUser -Name "AISTV-FOREVER" -ErrorAction SilentlyContinue
              }},
              @{Name="ÄÃ³ng káº¿t ná»‘i máº¡ng Tailscale"; Script={
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue
                  Start-Sleep -Seconds 5
              }},
              @{Name="XÃ³a rule firewall vÄ©nh cá»­u"; Script={
                  netsh advfirewall firewall delete rule name="RDP-VÄ©nh-Cá»­u" dir=in -ErrorAction SilentlyContinue
                  netsh advfirewall firewall delete rule name="RDP-VÄ©nh-Cá»­u-Out" dir=out -ErrorAction SilentlyContinue
              }},
              @{Name="KhÃ´i phá»¥c cÃ i Ä‘áº·t RDP gá»‘c"; Script={
                  Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue
                  Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue
                  Set-Service -Name TermService -StartupType Disabled -ErrorAction SilentlyContinue
              }},
              @{Name="Gá»¡ cÃ i Ä‘áº·t Tailscale"; Script={
                  $uninstallPath = "${env:ProgramFiles}\Tailscale\Uninstall-Tailscale.exe"
                  if (Test-Path $uninstallPath) {
                      Start-Process $uninstallPath -ArgumentList "/S" -Wait -ErrorAction SilentlyContinue
                  }
              }}
          )
          
          foreach($step in $cleanupSteps) {
              Write-Host "â”‚ ğŸ—‘ï¸  $($step.Name)..." -NoNewline -ForegroundColor Gray
              try {
                  & $step.Script
                  Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green
              } catch {
                  Write-Host "`râ”‚ âš ï¸  $($step.Name) - ÄÃ£ xá»­ lÃ½ an toÃ n" -ForegroundColor Yellow
              }
              Start-Sleep -Milliseconds 300
          }
          
          # Dá»n dáº¹p jobs cÃ²n sÃ³t
          Get-Job | Stop-Job -PassThru | Remove-Job -Force -ErrorAction SilentlyContinue
          
          Write-Host ""
          Write-Host "ğŸ‰ Dá»n dáº¹p há»‡ thá»‘ng vÄ©nh cá»­u hoÃ n táº¥t!" -ForegroundColor Green
          Write-Host "ğŸ‘‹ Háº¹n gáº·p láº¡i trong phiÃªn lÃ m viá»‡c tiáº¿p theo!" -ForegroundColor Cyan
